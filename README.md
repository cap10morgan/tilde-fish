# tilde-fish

A Fish shell configuration generator for the [tilde](https://github.com/cap10morgan/tilde) dotfiles management system.

## Overview

`tilde-fish` is a Rust-based tool that generates Fish shell configuration files from EDN (Extensible Data Notation) configuration. It serves as a plugin for the tilde dotfiles management system, allowing you to define your Fish shell configuration in a structured, declarative format.

## Features

- **Abbreviations**: Define Fish shell abbreviations for quick command expansion
- **Aliases**: Create command aliases
- **Environment Variables**: Set global environment variables
- **PATH Management**: Add directories to your PATH
- **Custom Functions**: Define Fish shell functions with multi-line support
- **Raw Fish Commands**: Include arbitrary Fish shell commands
- **Prompt Configuration**: Configure Fish prompt settings
- **Snippets**: Include custom code snippets with comments
- **Fish Greeting**: Customize the Fish shell greeting message

## Installation

### From Source

```bash
git clone <repository-url>
cd tilde-fish
cargo build --release
```

### From GitHub Releases

Download the appropriate binary for your platform from the [releases page](../../releases).

Available platforms:
- Linux (x86_64, ARM64)
- macOS (x86_64, ARM64)
- Windows (x86_64, ARM64)

## Usage

### As a Tilde Plugin

Add this to your tilde configuration:

```edn
{:fish {:source "path/to/tilde-fish"}}
```

### Standalone Usage

#### Generate Plugin Configuration

```bash
tilde-fish --config
```

#### Generate Fish Configuration

```bash
tilde-fish --gen-config < config.edn
```

## Configuration Format

The tool accepts EDN configuration with the following structure:

```edn
{:preambles {:tilde/all "# Custom header comment\\n"}
 :fish-greeting "Welcome to Fish!"  ; or nil to disable greeting
 :snippet/name "# Custom snippet\\necho 'Hello World'"
 :abbrs {"gs" "git status"
         "gc" "git commit"
         "gp" "git push"}
 :aliases {"ll" "ls -la"
           "la" "ls -A"
           "grep" "grep --color=auto"}
 :env {"EDITOR" "nvim"
       "BROWSER" "firefox"
       "TERM" "xterm-256color"}
 :paths ["/usr/local/bin"
         "~/.local/bin"
         "~/.cargo/bin"]
 :functions {"mkcd" "mkdir -p $argv[1]; and cd $argv[1]"
             "extract" "switch $argv[1]\\ncase '*.tar.gz'\\n    tar -xzf $argv[1]\\ncase '*.zip'\\n    unzip $argv[1]\\nend"}
 :fish ["set -g fish_prompt_pwd_dir_length 3"
        "set -g fish_color_command blue"]
 :prompt {:style "robbyrussell"
          :show-git true}}
```

### Configuration Options

#### `:preambles`
Map of preamble sections. The `:tilde/all` key adds a header comment to the generated file.

#### `:fish-greeting`
- String value: Sets a custom greeting message
- Empty string: Disables the Fish greeting

#### `:snippet/name`
Any key starting with `snippet/` will be treated as a custom code snippet. The part after `snippet/` becomes a comment header.

#### `:abbrs`
Map of abbreviation name to expansion. These become `abbr -a` commands in Fish.

#### `:aliases`
Map of alias name to command. These become `alias` commands in Fish.

#### `:env`
Map of environment variable name to value. These become `set -gx` commands in Fish.

#### `:paths`
Vector of paths to add to PATH. These become `fish_add_path` commands in Fish.

#### `:functions`
Map of function name to function body. Multi-line functions are supported using `\\n` for newlines.

#### `:fish`
Vector of raw Fish shell commands to include in the configuration.

#### `:prompt`
Map containing prompt configuration:
- `:style`: Sets the theme
- `:show-git`: Boolean to enable/disable git information in prompt

## Generated Output

The tool generates a complete Fish shell configuration file with:

1. Preamble comments
2. Fish greeting configuration
3. Custom snippets with headers
4. Abbreviations section
5. Aliases section
6. Environment variables section
7. PATH additions section
8. Custom functions section
9. Raw Fish commands section
10. Prompt configuration section

Example output:

```fish
# This config generated by tilde; DO NOT MODIFY\

set fish_greeting 'Welcome to Fish!'

# Custom snippet
# Hello World snippet
echo 'Hello World'

# Abbreviations
abbr -a -- gs 'git status'
abbr -a -- gc 'git commit'

# Aliases
alias ll 'ls -la'
alias grep 'grep --color=auto'

# Environment Variables
set -gx EDITOR 'nvim'
set -gx BROWSER 'firefox'

# PATH additions
fish_add_path /usr/local/bin
fish_add_path ~/.local/bin

# Functions
function mkcd
    mkdir -p $argv[1]; and cd $argv[1]
end

# Custom Fish Commands
set -g fish_prompt_pwd_dir_length 3
set -g fish_color_command blue

# Prompt Configuration
set -g theme robbyrussell
set -g fish_prompt_show_git true
```

## Development

### Prerequisites

- Rust 1.70+ with 2024 edition support
- Cargo

### Building

```bash
cargo build
```

### Testing

The project includes a comprehensive test suite with multiple types of tests:

#### Unit Tests
```bash
cargo test --lib
```
Tests core functionality of `fish_config` and `plugin_config` functions with 19 test cases covering:
- Plugin configuration generation and validation
- Fish greeting handling (string, empty, nil)
- Aliases, abbreviations, and environment variables
- PATH management and custom functions
- Multi-line function processing
- Raw fish commands and prompt configuration
- Edge cases and error handling

#### Integration Tests
```bash
cargo test --test integration_tests
```
Tests CLI functionality with 14 test cases covering:
- Command-line argument handling (`--config`, `--gen-config`)
- EDN parsing and error handling
- End-to-end configuration generation
- Individual feature testing (aliases, env vars, paths, functions, etc.)
- Invalid input handling and error messages

#### Property-Based Tests
```bash
cargo test --test property_tests
```
Runs 11 property-based tests using the `proptest` crate to verify:
- Function never panics with random inputs
- Output consistency and validation
- Section ordering and formatting
- Large configuration handling (up to 1000 aliases)
- Special character handling

#### Test Helpers
```bash
cargo test --test test_helpers
```
Provides 5 utility tests and helper functions for:
- Creating test configurations
- Validating fish shell syntax
- Extracting and parsing generated output
- Common test assertions and fixtures

#### Performance Benchmarks
```bash
cargo bench --bench fish_config_bench
```
Benchmarks performance with different configuration sizes:
- Empty config: ~26ns
- Small config: ~487ns  
- Medium config: ~4.9µs
- Large config: ~47µs
- 1000 aliases: ~138µs

#### All Tests
```bash
cargo test
```
Runs all test types (49 total tests) to ensure comprehensive coverage.

#### Manual Testing
```bash
cargo run -- --gen-config < test_config.edn
```

### Linting

```bash
cargo fmt
cargo clippy
```

## Dependencies

### Runtime Dependencies
- [`clojure-reader`](https://crates.io/crates/clojure-reader) - EDN parsing

### Development Dependencies  
- [`proptest`](https://crates.io/crates/proptest) - Property-based testing
- [`criterion`](https://crates.io/crates/criterion) - Performance benchmarking

## License

[Add your license here]

## Contributing

1. Fork the repository
2. Create a feature branch
3. Make your changes
4. Add tests if applicable:
   - Unit tests in `src/lib.rs` for core functionality
   - Integration tests in `tests/integration_tests.rs` for CLI behavior
   - Property tests in `tests/property_tests.rs` for edge cases
   - Helper functions in `tests/test_helpers.rs` for common utilities
5. Run the full test suite: `cargo test`
6. Run formatting and linting: `cargo fmt` and `cargo clippy`
7. Run benchmarks if performance-related: `cargo bench`
8. Submit a pull request

### Test Coverage
The project maintains comprehensive test coverage with:
- **49 total tests** across multiple test types
- **Unit tests** for core library functions
- **Integration tests** for CLI functionality  
- **Property-based tests** for robustness
- **Performance benchmarks** for optimization
- **Test helpers** for maintainability

## Changelog

See [CHANGELOG.md](CHANGELOG.md) for release history.
